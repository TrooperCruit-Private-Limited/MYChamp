@* @page
@model MYChamp.Pages.HolidayCalender.BIndexModel

@section Scripts {
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
}
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            debugger;
            const startDate = new Date('2025-01-01');
            const endDate = new Date('2025-12-31');
            $('#holidayDate').attr('min', startDate.toISOString().split('T')[0]);
            $('#holidayDate').attr('max', endDate.toISOString().split('T')[0]);

            // Load holidays on page load
            function loadHolidays() {
                $.ajax({
                    url: '/HolidayCalender/BIndex?handler=GetHolidays',
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            const tbody = $('#holidaysTable tbody');
                            tbody.empty();
                            response.data.forEach(function (holiday) {
                                tbody.append(`
                                    <tr id="holiday-${holiday.id}">
                                        <td class="holiday-name">${holiday.holidayName}</td>
                                        <td class="holiday-date" data-date="${holiday.holidayDate}">${new Date(holiday.holidayDate).toLocaleDateString()}</td>
                                        <td class="branch-name">${holiday.branchName}</td>
                                        <td class="holiday-limit">${holiday.limit}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm edit-btn" data-id="${holiday.id}">Edit</button>
                                            <button class="btn btn-danger btn-sm delete-btn" data-id="${holiday.id}">Delete</button>
                                        </td>
                                    </tr>
                                `);
                            });
                        } else {
                            alert('Error loading holidays: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('An error occurred while loading holidays.');
                    }
                });
            }

            loadHolidays();

            // Save holiday (Create or Edit)

         $('#saveHoliday').on('click', function (e) {
            e.preventDefault();

            const holidayData = {
                Id: parseInt($('#holidayId').val() || 0),
                HolidayName: $('#holidayName').val().trim(),
                HolidayDate: $('#holidayDate').val(),
                BranchName: $('#branchName').val(),
                Limit: parseInt($('#limit').val(), 10)
            };

            console.log('Sending Data:', holidayData);

            // Basic front-end validation
            if (!holidayData.HolidayName || !holidayData.HolidayDate || !holidayData.BranchName || !holidayData.Limit) {
                alert('All fields are required!');
                return;
            }

            if (holidayData.Limit < 1 || holidayData.Limit > 25) {
                alert('Holiday limit must be between 1 and 25.');
                return;
            }

            $.ajax({
                url: '/HolidayCalender/BIndex?handler=CreateOrEdit',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: JSON.stringify(holidayData),
                success: function (response) {
                    console.log('AJAX Response:', response);
                    if (response.success) {
                        alert('Holiday saved successfully!');

                         // Clear the form fields
                        $('#holidayForm').trigger('reset');
                         $('#holidayId').val(''); // Clear hidden field for ID


                        loadHolidays(); // Reload holidays
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr) {
                    console.error('AJAX Error Response:', xhr);
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'An unknown error occurred.';
                    alert('An error occurred: ' + errorMessage);
                }
            });
        });








            // Edit holiday
            $(document).on('click', '.edit-btn', function () {
                const id = $(this).data('id');
                const row = $(`#holiday-${id}`);
                $('#holidayId').val(id);
                $('#holidayName').val(row.find('.holiday-name').text());
                $('#holidayDate').val(row.find('.holiday-date').data('date'));
                $('#branchName').val(row.find('.branch-name').text());
                $('#limit').val(row.find('.holiday-limit').text());
            });

            // Delete holiday
                       $(document).on('click', '.delete-btn', function () {
            const id = $(this).data('id');
            console.log('Deleting Holiday with ID:', id); // Log the ID
            if (!id || isNaN(id)) {
                alert('Invalid ID');
                return;
            }
            if (confirm('Are you sure you want to delete this holiday?')) {
                       $.ajax({
            url: '/HolidayCalender/BIndex?handler=Delete',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify({ id: id }),
            success: function (response) {
                console.log('Response from server:', response);  // Check response
                if (response.success) {
                    alert('Holiday deleted successfully!');
                    loadHolidays();
                } else {
                    alert(response.message || 'Error deleting holiday.');
                }
            },
            error: function () {
                alert('An error occurred while deleting the holiday.');
            }
        });

            }
        });


        });
    </script>


</head>

<h2>Holiday Calendar</h2>

<!-- Form for Create/Edit -->
<form id="holidayForm">
    @Html.AntiForgeryToken()

    <input type="hidden" id="holidayId" name="holidayId" value="">

    <div class="form-group">
        <label>Holiday Name</label>
        <input type="text" id="holidayName" class="form-control" required />
    </div>

    <div class="form-group">
        <label>Holiday Date</label>
        <input type="date" id="holidayDate" class="form-control" required />
    </div>

    <div class="form-group">
        <label>Branch Name</label>
        <select id="branchName" class="form-control" required>
            <option value="">-- Select a Branch --</option>
            <option value="Europe">Europe</option>
            <option value="Australia">Australia</option>
            <option value="India">India</option>
        </select>
    </div>

    <div class="form-group">
        <label>Limit</label>
        <input type="number" id="limit" class="form-control" max="25" min="1" required />
    </div>

    <button type="button" id="saveHoliday" class="btn btn-primary">Save Holiday</button>
</form>


<hr />

<!-- Table to Display Holidays -->
<div style="max-height: 300px; overflow-y: auto;">
    <table class="table table-striped" id="holidaysTable">
        <thead>
            <tr>
                <th>Holiday Name</th>
                <th>Holiday Date</th>
                <th>Branch Name</th>
                <th>Limit</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Holidays will be loaded dynamically -->
        </tbody>
    </table>
</div>

 *@